

## 现象描述
使用高防 IP 之后，访问业务出现502报错：Bad Gateway。

## 可能原因
使用高防 IP 后的业务流量走向图：
![](https://main.qcloudimg.com/raw/d4b6714f20554c2b9255a946364007fa.png)

### 原因一：高防回源 IP 被源站拦截或限速
在配置高防 IP 后，真实服务器（源站）的 IP 因为高防 IP 在中间代理而被隐藏。因此，在源站看来，所有经过高防 IP 服务访问的客户端源 IP 都会变成高防的回源 IP。如此一来源站接收到的访问请求都是来自高防 IP 回源段，而高防 IP 回源段的数量是有限的，分摊过后在源站看来每个回源 IP 的请求量都会很大。假若源站做了防护 DDos 攻击的安全策略，有可能会触发这个策略从而导致将回源 IP 限速甚至拦截。

### 原因二：源站本身异常，导致响应高防的请求超时
导致异常的可能原因：
- 源站 IP 暴露，被恶意攻击导致瘫痪。
- 源站服务器机房物理故障。
- 源站服务器中 Apache、Nginx 等 Web 程序出现问题。
- 服务器内存、CPU 占用过高，导致性能骤降。
- 源站上行链路拥挤阻塞。

### 原因三：网络抖动或者链路故障
网络抖动或者链路故障造成的业务访问不稳定，提示502报错。

## 解决思路
### 原因一：解决思路
可以通过第三方测试网站和测试工具对源站和高防 IP 做对比访问，根据测试结果来判断问题原因。
1. 在第三方拨测平台（如 boce.com 17ce）进行 HTTP 拨测源站和高防，对比源站和高防的访问情况，如源站正常、高防大范围异常，则进行下一步。
2. 使用压测工具（如 ab、webbench）对源站进行压测（此时注意客户的 CC 开关情况），再次进行访问，如果出现访问异常的情况，可以确定大概率是由于安全策略导致。

### 原因二：解决思路
首先通过修改本地 hosts 文件，将域名指向源站 IP。进行访问测试，若访问异常同时出 ping、telnet 丢包超时等现象，可判断为是此类原因导致。
- 更换源站 IP。
- 请相关人员进行机房故障检查，修复物理故障。
- 确认 Web 服务是否正常并修复。
- 检查服务器进程占用，内存占用等性能参数是否正常并恢复至正常状态。
- 查看源站上行链路监控设备监控到的流量状态，可通过更换链路或者流控等方式进行规避。

### 原因三：解决思路
确定是否存在链路故障情况并修复。

## 处理步骤
### 原因一：处理步骤
- 将高防 IP 回源段添加至防火墙、主机安全防护软件（如安全狗）的白名单中。
- 关闭源站的防火墙以及主机安全防护软件。

### 原因二：处理步骤
- 查看源站流量、请求量是否有大量增长，同时对比高防 IP 管理控制台中的监控。
如果源站遭到大流量攻击，但高防 IP 管理控制台显示无异常，则有可能是攻击绕过高防 IP 直接攻击源站。这种情况，建议您尽快更换源站 IP。
- 查看源站服务器机房是否出现断电，网卡， 驱动，内存以及接线等物理硬件故障情况，及时更新或修复。
- 查看源站服务器的相关监控，各项进程状态，CPU/内存的使用率、带宽的使用率等情况。
如有异常，请您联系相关的技术人员或机房负责人员协助排查问题。
- 由服务器技术人员针对源站服务器中 Apache、Nginx 等服务状态进行修复。
- 使用其他带宽空闲链路或针对业务添加带宽保障策略，确保分配给业务流量的带宽处于正常范围，不被抢占。

### 原因三：处理步骤
- [提交工单](https://console.cloud.tencent.com/workorder/category) 详细说明地域、运营商等情况，售后团队会为您提供相应的链路质量监控情况。
- 通过第三方拨测工具（如 www.boce.com）进行网络质量的检测和监控。
